# SQL

--- INSERT DATADAILY ctrl K + ctrl C -  ctrl K + ctrl U
	INSERT INTO sktv SELECT * FROM sktv20240717
	;


--EXEC xp_readerrorlog;

--- VIEW DATA
select * from sktv where PROCESS_DATE = '2024-07-17 00:00:00.000'


----- CREAT #LOAN
	DROP TABLE IF EXISTS #LOAN
	SELECT 
		FORMAT (PROCESS_DATE, 'yyyy') as NAM, FORMAT (PROCESS_DATE, 'MM') as THANG
		,FORMAT (PROCESS_DATE, 'dd/MM/yyyy') as NGAY_DU_LIEU,REGION ---D 
		, BRNID, BRNAME, CHI_NHANH, CCY , ACCOUNT_NUMBER, CUST_ID, NHOMNO, FULL_NAME, CUS_TYPE
		, MALHINH, TENLHINH,HOPDONG, (DUNOQUYDOI)/1e9 as AMT, DUNO_NT, RATE, THOIHAN, HMUCTINDUNG, NGAYVAY, NGAYDHAN, STIENGIAINGAN
		, SNGAYQHANLAI, SNGAYQHANGOC, NGAYCOCAUNO, HINHTHUC_COCAU, NGAY_DUYET_CO_CAU, MANV, TENNV, QUY_MO_DN, DCHI, CHUONG_TRINH_VAY
		, PHANKHUCKH, MAXOVD 
	INTO #LOAN
	FROM
		(
			SELECT * --- TABLE C GAN VUNG 
			,(CASE
				WHEN CHARINDEX ('#', TENNV_QHKH) > 0
				THEN LEFT (TENNV_QHKH,CHARINDEX ('#', TENNV_QHKH)-1)
				ELSE TENNV_QHKH 
			END) AS TENNV
			,(CASE
				WHEN BRNAME IN ( 'HOI SO','PHONG QHKH1','PHONG SMES HO', 'PHONG QHKH2'  ) THEN 'HOI SO'
				WHEN BRNAME IN ( 'CHI NHANH LONG BIEN','CHI NHANH PHU THO','CHI NHANH HA TINH', 'SMES BVB HO GUOM','CHI NHANH HUNG YEN'
								, 'SMES BVB MY DINH', 'PGD HONG BANG', 'PGD MY DINH', 'PGD NGO QUYEN', 'PGD HAI AN','CHI NHANH BAC GIANG'
								, 'CHI NHANH THAI NGUYEN', 'PGD KINH BAC', 'PGD TU SON', 'PGD CAM PHA' , 'PGD VINH', 'PGD BEN THUY', 'PGD BAI CHAY'
								, 'PGD DIEN CHAU', 'PGD QUE VO', 'PGD MONG CAI', 'CHI NHANH THU DO', 'CHI NHANH THANH HOA' ,'CHI NHANH BAC NINH'
								, 'CHI NHANH NGHE AN', 'CHI NHANH THANG LONG', 'CHI NHANH HAI PHONG', 'CHI NHANH QUANG NINH', 'CHI NHANH HA NOI'
								, 'PGD HOAN KIEM', 'PGD BA DINH', 'PGD CAU GIAY', 'PGD DONG DA', 'PGD HAI BA TRUNG'  ) THEN 'MIEN BAC'
				WHEN BRNAME IN ( 'CHI NHANH VUNG TAU','CHI NHANH BINH DUONG','CHI NHANH TAY NINH', 'CHI NHANH DONG NAI','CHI NHANH BINH THUAN'
								, 'PGD SO SAO', 'PGD TAN BIEN', 'PGD BIEN HOA', 'PGD LONG KHANH', 'PGD TRANG BOM', 'PGD DI AN', 'PGD CHAU DUC'
								, 'PGD TAN UYEN', 'PGD PHAN THIET', 'PGD TRANG BANG', 'PGD BA RIA' , 'PGD HOA THANH', 'CHI NHANH THUAN AN', 'PGD PHAN RI CUA'
								, 'PGD LA GI', 'CHI NHANH BINH PHUOC', 'PGD PHUOC LONG', 'PGD PHU MY' ) THEN 'MIEN DONG'
				WHEN BRNAME IN ( 'PGD RACH GIA','PGD DUC HOA','PGD HA TIEN', 'PGD PHU QUOC','PGD CHAU DOC', 'PGD CHAU DOC', 'PGD MY THO', 'PGD MINH HAI'
								, 'PGD SONG DOC', 'PGD NGA NAM', 'PGD HUNG VUONG', 'CHI NHANH DONG THAP', 'PGD DAM DOI', 'PGD BEN LUC', 'PGD PHU TAN'
								, 'PGD NINH KIEU', 'PGD KIEN TUONG', 'PGD CAI LAY', 'PGD CO DO' , 'CHI NHANH SOC TRANG', 'PGD THOT NOT', 'PGD THOAI SON'
								, 'PGD GO CONG', 'CHI NHANH KIEN GIANG', 'CHI NHANH LONG AN', 'CHI NHANH CA MAU', 'CHI NHANH TIEN GIANG', 'CHI NHANH AN GIANG'
								, 'CHI NHANH CAN THO') THEN 'MIEN TAY'
				WHEN BRNAME IN ( 'CHI NHANH DAK LAK','CHI NHANH DA NANG','PGD HAI CHAU', 'PGD BUON HO','CHI NHANH NHA TRANG', 'PGD SONG HAN', 'PGD THANH KHE'
								, 'PGD KRONG PAC', 'PGD LAK', 'CHI NHANH GIA LAI', 'PGD BINH TAN', 'PGD VINH HAI', 'PGD DAK DOA', 'PGD CHU SE'
								, 'CHI NHANH NAM DA NANG', 'CHI NHANH LAM DONG', 'CHI NHANH BINH DINH', 'PGD CAM RANH' , 'CHI NHANH DAK NONG', 'PGD PLEIKU' )
								THEN 'MIEN TRUNG'
				WHEN BRNAME IN ( 'NGAN HANG SO','DIGIBANK','DIGIBANK 810', 'TIMO PLUS 902') THEN 'NHDT'
				WHEN BRNAME IN ( 'SME BVB LE VAN SY','SMES BVB THU DUC', 'SMES BVB CHO LON', 'SMES BVB GO VAP', 'SMES BVB PHU NHUAN', 'SMES BVB QUAN 10'
								, 'SMES BVB TAN BINH', 'SMES BVB PHU MY HUNG', 'SMES BVB BINH THANH', 'CHI NHANH BAC SAI GON', 'TTKD', 'PGD QUAN 10'
								, 'PGD LE VAN SY', 'PGD CHO LON', 'PGD PHU MY HUNG', 'PGD BINH THANH', 'PGD THU DUC', 'PGD QUAN 11', 'PGD BEN THANH'
								, 'CHI NHANH TAY SAI GON','CHI NHANH DONG SAI GON', 'CHI NHANH NAM SAI GON', 'PGD TAN BINH', 'PGD TAN BINH', 'PGD PHU NHUAN')
								THEN 'TP HCM'
				WHEN BRNAME IN ( 'TRUNG TAM QUAN LY VA THU HOI NO') THEN 'TTXLN'
				ELSE ''
			END ) AS REGION
		FROM 
			(
				SELECT * 
				FROM --- TABLE B
					(
						SELECT *, -- TABLE A
							(CASE -- CHUYEN MA CN SAU KHI GOP TABLE SKTV
								WHEN BRNAME IN ('CHI NHANH HA NOI') THEN '004'
								WHEN BRNAME IN ('CHI NHANH NAM SAI GON') THEN '003'
								WHEN BRNAME IN ('CHI NHANH BAC SAI GON') THEN '107'
								WHEN BRNAME IN ('CHI NHANH DONG SAI GON') THEN '002'
								WHEN BRNAME IN ('CHI NHANH TAY SAI GON') THEN '001'
								WHEN BRNAME IN ('CHI NHANH THANG LONG') THEN '038'
								WHEN BRNAME IN ('PGD PHU MY') THEN '086'
								ELSE BRANCH_ID
							END) AS BRNID
						FROM
							(
								SELECT *, -- TABLE SKTV 
									(CASE -- GOP CN
										WHEN BRANCH_NAME IN ('CHI NHANH THU DO','PGD CAU GIAY', 'PGD DONG DA', 'PGD HOAN KIEM', 'SMES BVB HO GUOM') THEN 'CHI NHANH HA NOI'
										WHEN BRANCH_NAME IN ('PGD BEN THANH','PGD PHU MY HUNG', 'SMES BVB CHO LON', 'SMES BVB PHU MY HUNG','PGD CHO LON') THEN 'CHI NHANH NAM SAI GON'
										WHEN BRANCH_NAME IN ('SMES BVB GO VAP','PGD GO VAP', 'SMES BVB TAN BINH', 'SMES BVB BINH THANH') THEN 'CHI NHANH BAC SAI GON'
										WHEN BRANCH_NAME IN ('PGD THU DUC','SMES BVB THU DUC') THEN 'CHI NHANH DONG SAI GON'
										WHEN BRANCH_NAME IN ('SME BVB LE VAN SY','SMES BVB PHU NHUAN','SMES BVB QUAN 10') THEN 'CHI NHANH TAY SAI GON'
										WHEN BRANCH_NAME IN ('SMES BVB MY DINH') THEN 'CHI NHANH THANG LONG'
										WHEN BRANCH_NAME IN ('PGD TAN THANH') THEN 'PGD PHU MY'
										ELSE BRANCH_NAME
									END) AS BRNAME,
									(CASE -- PHAN KHUC
										WHEN QUY_MO_DN IS NULL THEN 'MSME'
										WHEN QUY_MO_DN IN ('DNL','DSL') THEN 'CIB'
										WHEN QUY_MO_DN IN ('DNN','DNV') THEN 'SME'
										WHEN QUY_MO_DN IN ('DSN1','DSN2') THEN 'MSME'
									END) AS PHANKHUCKH,
									(CASE --- MAXOVD
										WHEN SNGAYQHANLAI > SNGAYQHANGOC THEN SNGAYQHANLAI ELSE SNGAYQHANGOC
									END) AS MAXOVD
								FROM sktv
							)A
						)B
				)C
			)D
--- VIEW DATA
 SELECT * FROM #LOAN WHERE NGAY_DU_LIEU = '17/07/2024'
 ---------------------------------------------------------------------------------------------------------------------
---DAILY REPORT (EOP + OVD)
--- RAW DATA
	SELECT 		
		NGAY_DU_LIEU,REGION ---D 
		, BRNID, BRNAME, CHI_NHANH, CCY , ACCOUNT_NUMBER, CUST_ID, NHOMNO, FULL_NAME, CUS_TYPE
		, MALHINH, TENLHINH,HOPDONG, AMT, DUNO_NT, RATE, THOIHAN, HMUCTINDUNG, NGAYVAY, NGAYDHAN, STIENGIAINGAN
		, SNGAYQHANLAI, SNGAYQHANGOC, NGAYCOCAUNO, HINHTHUC_COCAU, NGAY_DUYET_CO_CAU, MANV, TENNV, QUY_MO_DN
		, PHANKHUCKH, MAXOVD 
	FROM #LOAN 
	WHERE NGAY_DU_LIEU IN ('28/06/2024','09/07/2024','16/07/2024','17/07/2024') --- sua ngay data
	ORDER BY NGAY_DU_LIEU
	; 
--- I. EOP LOAN
	---I.1  SO SANH CHI NHANH CASE WHEN
		SELECT
		distinct REGION, BRNID, BRNAME
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  CUST_ID ELSE '' END ) AS '17/07/2024'
		,SUM (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  AMT ELSE '' END ) AS '17/07/2024'
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '16/07/2024' THEN  CUST_ID ELSE '' END ) AS '16/07/2024'
		,SUM (CASE WHEN NGAY_DU_LIEU = '16/07/2024' THEN  AMT ELSE '' END ) AS '16/07/2024'
		,'' as '27/12/2024'
		,'' as '27/12/2024'
		,'' as '30/11/2024'
		,'' as '30/11/2024'
		,'' as '31/10/2024'
		,'' as '31/10/2024'
		,'' as '30/09/2024'
		,'' as '30/09/2024'
		,'' as '30/08/2024'
		,'' as '30/08/2024'
		,'' as '31/07/2024'
		,'' as '31/07/2024'
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '28/06/2024' THEN  CUST_ID ELSE '' END ) AS '28/06/2024'
		,SUM (CASE WHEN NGAY_DU_LIEU = '28/06/2024' THEN  AMT ELSE '' END ) AS '28/06/2024'
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '31/05/2024' THEN  CUST_ID ELSE '' END ) AS '31/05/2024'
		,SUM (CASE WHEN NGAY_DU_LIEU = '31/05/2024' THEN  AMT ELSE '' END ) AS '31/05/2024'
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '29/04/2024' THEN  CUST_ID ELSE '' END ) AS '29/04/2024'
		,SUM (CASE WHEN NGAY_DU_LIEU = '29/04/2024' THEN  AMT ELSE '' END ) AS '29/04/2024'
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '29/03/2024' THEN  CUST_ID ELSE '' END ) AS '29/03/2024'
		,SUM (CASE WHEN NGAY_DU_LIEU = '29/03/2024'THEN  AMT ELSE '' END ) AS '29/03/2024'
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '29/02/2024' THEN  CUST_ID ELSE '' END ) AS '29/02/2024'
		,SUM (CASE WHEN NGAY_DU_LIEU = '29/02/2024' THEN  AMT ELSE '' END ) AS '29/02/2024'
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '31/01/2024' THEN  CUST_ID ELSE '' END ) AS '31/01/2024'
		,SUM (CASE WHEN NGAY_DU_LIEU = '31/01/2024' THEN  AMT ELSE '' END ) AS '31/01/2024'
		,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '29/12/2023' THEN  CUST_ID ELSE '' END ) AS '29/12/2023'
		,SUM (CASE WHEN NGAY_DU_LIEU = '29/12/2023' THEN  AMT ELSE '' END ) AS '29/12/2023'
	FROM 
		(
			SELECT * 
			FROM #LOAN 
			WHERE AMT IS NOT NULL
		)A
	GROUP BY REGION, BRNID, BRNAME 
	ORDER BY REGION ASC------ sua ngay data
	;

	--- I.2 SO SANH KHACH HANG CASEWHEN
		SELECT
			REGION, BRNID, BRNAME, FULL_NAME, CUST_ID
			,MAX (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  NHOMNO ELSE '' END ) AS '17/07/2024'
			,SUM (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  AMT ELSE '' END ) AS '17/07/2024'
			,MAX (CASE WHEN NGAY_DU_LIEU = '28/06/2024' THEN  NHOMNO ELSE '' END ) AS '28/06/2024'
			,SUM (CASE WHEN NGAY_DU_LIEU = '28/06/2024' THEN  AMT ELSE '' END ) AS '28/06/2024'
		FROM 
			(
				SELECT * 
				FROM #LOAN 
				WHERE NGAY_DU_LIEU IN ('28/06/2024', '17/07/2024')	
				AND AMT IS NOT NULL
			)A
		group by REGION, BRNID, BRNAME, FULL_NAME, CUST_ID --- sua ngay data
	;

--- II. OVDs
	---- II.1 DASHBOARD
		---- II.1.a CREATE #DUNOTUAN
		DROP TABLE IF EXISTS #DUNOTUAN
		SELECT A1.REGION, A1.BRNID, A1.BRNAME, A1.s1, A1.a1
											 ,A2.s2, A2.a2
		INTO #DUNOTUAN
		FROM 
			(
				SELECT
					REGION, BRNID, BRNAME
					,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  CUST_ID ELSE '' END ) AS s1
					,SUM (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  AMT ELSE '' END ) AS a1	
				FROM 
					(
						SELECT * 
						FROM #LOAN 
						WHERE NGAY_DU_LIEU IN ('17/07/2024')
					)A
				group by REGION, BRNID, BRNAME
			)A1
		LEFT JOIN
			(
				SELECT
					REGION, BRNID, BRNAME
					,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  CUST_ID ELSE '' END ) AS s2
					,SUM (CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  AMT ELSE '' END ) AS a2
				FROM 
					(
						SELECT * 
						FROM #LOAN 
						WHERE NGAY_DU_LIEU IN ('10/07/2024')
					)A
				group by REGION, BRNID, BRNAME
			)A2
		ON A1.BRNID = A2.BRNID
		;
		---- II.1.b CREATE #NHOM1
		DROP TABLE IF EXISTS #NHOM1;
		SELECT A1.REGION, A1.BRNID, A1.BRNAME, A1.s11, A1.a11
											,A2.s12, A2.a12
		INTO #NHOM1
		FROM 
			(
				SELECT
					REGION, BRNID, BRNAME
					,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  CUST_ID ELSE '' END ) AS s11
					,SUM (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  AMT ELSE '' END ) AS a11
				FROM 
					(
						SELECT * 
						FROM #LOAN 
						WHERE NGAY_DU_LIEU IN ('17/07/2024')
						AND NHOMNO ='1'
						AND MAXOVD >0
					)A
				group by REGION, BRNID, BRNAME
			)A1
		LEFT JOIN
			(
				SELECT
					REGION, BRNID, BRNAME
					,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  CUST_ID ELSE '' END ) AS s12
					,SUM (CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  AMT ELSE '' END ) AS a12
				FROM 
					(
						SELECT * 
						FROM #LOAN 
						WHERE NGAY_DU_LIEU IN ('10/07/2024')
						AND NHOMNO ='1'
						AND MAXOVD >0
					)A
				group by REGION, BRNID, BRNAME
			) A2
		ON A1.BRNID = A2.BRNID
		;
		---- II.1.c CREATE #NHOM2
		DROP TABLE IF EXISTS #NHOM2;
		SELECT A1.REGION, A1.BRNID, A1.BRNAME, A1.a21, A1.s21
											,A2.s22, A2.a22
		INTO #NHOM2
		FROM 
			(
			SELECT REGION, BRNID, BRNAME
					,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  CUST_ID ELSE '' END ) AS s21
					,SUM (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  AMT ELSE '' END ) AS a21
			FROM 
				(
					SELECT * 
					FROM #LOAN 
					WHERE NGAY_DU_LIEU IN ('17/07/2024')
					AND NHOMNO ='2'
				)A
			group by REGION, BRNID, BRNAME
			)A1
		LEFT JOIN
			(
			SELECT REGION, BRNID, BRNAME
					,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  CUST_ID ELSE '' END ) AS s22
					,SUM (CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  AMT ELSE '' END ) AS a22
			FROM 
				(
				SELECT * 
				FROM #LOAN 
				WHERE NGAY_DU_LIEU IN ('10/07/2024')
				AND NHOMNO ='2'
				)A
			group by REGION, BRNID, BRNAME
			)A2
		ON A1.BRNID = A2.BRNID
		;
		---- II.1.d CREATE NHOM345
		DROP TABLE IF EXISTS #NHOM345;
		SELECT A1.REGION, A1.BRNID, A1.BRNAME, A1.s31, A1.a31
												,A2.s32, A2.a32
		INTO #NHOM345
		FROM 
			(
				SELECT REGION, BRNID, BRNAME
				,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  CUST_ID ELSE '' END ) AS s31
				,SUM (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  AMT ELSE '' END ) AS a31
				
				FROM 
					(
						SELECT * 
						FROM #LOAN
						WHERE NGAY_DU_LIEU IN ('17/07/2024')
						AND NHOMNO IN ('3','4','5')
					)A
				group by REGION, BRNID, BRNAME
			)A1
			LEFT JOIN
				(
					SELECT
						distinct REGION, BRNID, BRNAME
						,COUNT (distinct CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  CUST_ID ELSE '' END ) AS s32
						,SUM (CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  AMT ELSE '' END ) AS a32
					FROM 
						(
							SELECT * 
							FROM #LOAN
							WHERE NGAY_DU_LIEU IN ('10/07/2024')
							AND NHOMNO IN ('3','4','5')
									
						)A
					group by REGION, BRNID, BRNAME
				)A2
		ON A1.BRNID = A2.BRNID
		;	
		---- II.1.e JOIN
		SELECT A.REGION, A.BRNID, A.BRNAME 
				, A.s1, A.a1, B.s11, B.a11, C.s21, C.a21, D.s31, D.a31
				, A.s2, A.a2, B.s12, B.a12, C.s22, C.a22, D.s32, D.a32
		FROM #DUNOTUAN A
		LEFT JOIN #NHOM1 B
		ON A.BRNID = B.BRNID
		LEFT JOIN #NHOM2 C
		ON A.BRNID = C.BRNID
		LEFT JOIN #NHOM345 D
		ON A.BRNID = D.BRNID
		ORDER BY REGION, BRNAME
		;

	---- II.2 PIVOT KH
		SELECT
			REGION, BRNID, BRNAME, FULL_NAME, CUST_ID
			, MAX (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  NHOMNO ELSE '' END ) NHOMNO08
			, MAX (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  MAXOVD ELSE '' END ) AS MAXOVD08
			, SUM (CASE WHEN NGAY_DU_LIEU = '17/07/2024' THEN  AMT ELSE '' END ) AS AMT08
			, MAX (CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  NHOMNO ELSE '' END ) NHOMNO08
			, MAX (CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  MAXOVD ELSE '' END ) AS MAXOVD08
			, SUM (CASE WHEN NGAY_DU_LIEU = '10/07/2024' THEN  AMT ELSE '' END ) AS AMT08
		FROM 
			(
				SELECT * 
				FROM #LOAN 
				WHERE NGAY_DU_LIEU IN ('10/07/2024', '17/07/2024')
			)A
		GROUP BY REGION, BRNID, BRNAME, FULL_NAME, CUST_ID
		;

